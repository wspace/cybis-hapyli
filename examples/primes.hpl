import "stdlib"

var *prompt = "Enter a number: "
def main () = (do (print-string *prompt)
                  (print-primes-to (read-number)))
                  
def print-primes-to (n) = (print-list-nonzero (seive (range 2 n)
                                                     (- n 1))
                                              (- n 1))

def range (from to) = (range (alloc (+ (- to from) 1))
                             from
                             to)
                             
def range (*buffer from to) = (if (> from to)
                                  0
                                  (do (set *buffer from)
                                      (range (+ *buffer 1) (+ from 1) to)
                                      *buffer))

def print-list-nonzero (*buffer n) = 
    (if (== n 0)
        0
        (do (if (ref *buffer)
                (do (print-number (ref *buffer))
                    (print-char '\n'))
                0)
            (print-list-nonzero (+ *buffer 1) (- n 1))))
      
def seive (*buffer length) = (do
    (if (== length 0)
        0
        (if (== (ref *buffer) 0)
            (seive (+ *buffer 1) (- length 1))
            (seive (zero-multiples-of (ref *buffer)
                                      (+ *buffer 1)
                                      (- length 1))
                    (- length 1))))
    *buffer)
                                     
def zero-multiples-of (m *buffer length) = 
    (if (== length 0)
        0
        (do (if (% (ref *buffer) m) 0
                (set *buffer 0))
            (zero-multiples-of m (+ *buffer 1) (- length 1))
            *buffer))
